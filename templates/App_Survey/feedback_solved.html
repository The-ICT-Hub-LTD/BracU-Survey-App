{% extends 'layouts/base.html' %} 
{% block span_block %} 
All Feedbacks 
{% endblock span_block %} 

{% block body_block %}

    <div class="card card-default">
      <div class="card-header">
        <h2>All Resolved Table</h2>
      </div>
      <div class="card-body">
        <form method="GET" action="{% url 'App_Survey:resolved' %}" class="mb-3">
          <div class="row">
              <div class="col-md-4">
                  <input
                      type="text"
                      name="student_id"
                      class="form-control"
                      placeholder="Search by ID"
                      value="{{ student_id|default:'' }}"
                  >
              </div>
              <div class="col-md-1" style="margin-right: 10px;">
                  <button type="submit" class="btn btn-primary btn-sm" >Search</button>
              </div>
              <div class="col-md-1">
                  <a href="{% url 'App_Survey:resolved' %}" class="btn btn-secondary btn-sm">X</a>
              </div>
              <div class="col-md-2">
                <!-- <h3 style="color: white">.</h3> -->
                <a href="{% url 'App_Survey:export_complaints_csv' %}" class="btn btn-success btn-sm">CSV Download</a>

              </div>
          </div>
        </form>
      
        <div class="collapse" id="collapse-data-tables">
          <pre class="language-html mb-4"></pre>
        </div>
        <table
          id="productsTable"
          class="table table-hover table-product"
          style="width: 100%"
        >
          <thead>
            <tr>
                <th>SL</th>
                <th>Name</th>
                <th>ID</th>
                <!-- <th>Feedbacks</th> -->
                <th>Complain Image</th>
                <th>Status</th>
                <th>Issued</th>
                <!-- <th>Solution  </th> -->
                <th>Resolved Image</th>
                <th>Resolved At</th>
                <th>View</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;" -->
            {% for complain in complaints %}
            <tr id="complain-row-{{ complain.id }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ complain.student_name }}</td>
                <td>{{ complain.student_id }}</td>
                <!-- <td>{{ complain.problem_details | truncatechars:10  }}</td> -->
                <td style="text-align: center;">
                    {% if complain.complain_image %}
                        <span class="mdi mdi-image-multiple large" style="cursor: pointer;" onclick="viewImage('{{ complain.complain_image.url }}')" ></span>
                    {% else %}
                        Feedback
                    {% endif %}
                </td>
                <td>{{ complain.feedback_status }}</td>
                <td>{{ complain.submitted_at }}</td>
                <!-- <td>{{ complain.solution_details | truncatechars:10}}</td> -->
                <td style="text-align: center;">
                    {% if complain.resolved_image %}
                        <span class="mdi mdi-image-multiple large" style="cursor: pointer;" onclick="viewImage('{{ complain.resolved_image.url }}')" ></span>
                    {% else %}
                        No image
                    {% endif %}
                </td>
                <td>{{ complain.resolved_at }}</td>
                <td>
                    <button
                      type="button"
                      class="btn btn-info btn-pill btn-sm"
                      data-toggle="modal"
                      data-target="#exampleModalForm"
                      onclick="viewComplainDetails(
                          '{{ complain.student_name }}', 
                          '{{ complain.student_id }}', 
                          '{{ complain.solution_details }}', 
                          {% if complain.resolved_image %}'{{ complain.resolved_image.url }}'{% else %}null{% endif %}, 
                          '{{ complain.category }}', 
                          '{{ complain.problem_details }}', 
                          '{{ complain.invoice_no }}', 
                          {% if complain.invoice_image %}'{{ complain.invoice_image.url }}'{% else %}null{% endif %},  
                          {% if complain.complain_image %}'{{ complain.complain_image.url }}'{% else %}null{% endif %}, 
                          '{{ complain.submitted_at }}', 
                          '{{ complain.feedback_status }}')">
                      View
                    </button>
                  </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

        <div class="card card-default align-items-end">
            <div class="card-body">
                <nav aria-label="Page navigation example">
                    <ul class="pagination">
                    {% if complaints.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ complaints.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true" class="mdi mdi-chevron-left"></span>
                        <span class="sr-only">Previous</span>
                        </a>
                    </li>
                    {% endif %}

                    {% for i in complaints.paginator.page_range %}
                        {% if complaints.number == i %}
                            <li class="page-item active"><a href="?page={{ i }}" class="page-link">{{ i }}</a></li>
                        {% else %}
                            <li class="page-item"><a href="?page={{ i }}" class="page-link">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if complaints.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ complaints.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true" class="mdi mdi-chevron-right"></span>
                        <span class="sr-only">Next</span>
                        </a>
                    </li>
                    {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>


<!-- View Details -->
<!--============== View Modal ==============-->
<div class="modal fade" id="exampleModalForm" tabindex="-1" role="dialog" aria-labelledby="exampleModalFormTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalFormTitle">Resolved Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">Ã—</span>
          </button>
        </div>
        <div class="modal-body">
          <p><strong>Name:</strong> <span id="modalStudentName"></span></p>
          <p><strong>ID:</strong> <span id="modalStudentID"></span></p>
          <p><strong>Resolved Details:</strong> <span id="modalProblemDetails"></span></p>
          <p><strong>Resolved Image:</strong> 
            <img id="modalComplainImage" src="" alt="Resolved Image" style="max-width: 100%; display: none;">
            <span id="modalComplainImagePlaceholder"></span>
          </p>
          <hr>
          <p><strong>Category:</strong> <span id="modalCategory"></span></p>
          <p><strong>Problem Details:</strong> <span id="modalProblem"></span></p>
          <p><strong>Invoice No:</strong> <span id="modalInvoice"></span></p>
          <p><strong>Invoice Image:</strong> 
            <img id="modalInvoiceImage" src="" alt="Invoice Image" style="max-width: 100%; display: none;">
            <span id="modalInvoiceImagePlaceholder"></span>
          </p>
          <br>
          <p><strong>Complain Image:</strong> 
            <img id="modalProblemImage" src="" alt="Complain Image" style="max-width: 100%; display: none;">
            <span id="modalProblemPlaceholder"></span>
          </p>
          <hr>
          <p><strong>Resolved At:</strong> <span id="modalResolvedAt"></span></p>
          <p><strong>Feedback Status:</strong> <span id="modalFeedbackStatus"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger btn-pill" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

<!-- Image View -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Feedback Image</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="Complaint Image" class="img-fluid" />
            </div>
        </div>
    </div>
</div>

<!-- Modal for Editing Complaint -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Updated Feedbacks</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <div id="modalEditForm">
                  
              </div>
          </div>
      </div>
  </div>
</div>

<script>
    function viewImage(imageUrl) {
        document.getElementById('modalImage').src = imageUrl;
        $('#imageModal').modal('show');
    }

    function openEditModal(complainId) {
        $.ajax({
            url: "{% url 'App_Survey:edit_complain' 0 %}".replace(0, complainId),
            type: "GET",
            success: function(response) {
                $('#modalEditForm').html(response.html);
                $('#editModal').modal('hide');
            },
            error: function(xhr, status, error) {
                console.log("Error loading modal:", error);
            }
        });
    }

    // View Modal
    function viewComplainDetails(student_name, student_id, solution_details, resolved_image, category, problem_details, invoice_no, invoice_image, complain_image, resolved_at, feedback_status) {
    document.getElementById('modalStudentName').textContent = student_name;
    document.getElementById('modalStudentID').textContent = student_id;
    document.getElementById('modalProblemDetails').textContent = solution_details;

    
    const modalComplainImage = document.getElementById('modalComplainImage');
    if (resolved_image && resolved_image !== "None") {
      modalComplainImage.src = resolved_image;
      modalComplainImage.style.display = "block"; 
    } else {
      modalComplainImage.style.display = "none"; 
      document.getElementById('modalComplainImagePlaceholder').textContent = "No Image Available";
    }
    document.getElementById('modalCategory').textContent = category;
    document.getElementById('modalProblem').textContent = problem_details;
    document.getElementById('modalInvoice').textContent = invoice_no;

    const modalInvoiceImage = document.getElementById('modalInvoiceImage');
      if (invoice_image && invoice_image !== "None") {
        modalInvoiceImage.src = invoice_image;
        modalInvoiceImage.style.display = "block"; 
      } else {
        modalInvoiceImage.style.display = "none"; 
        document.getElementById('modalInvoiceImagePlaceholder').textContent = "No Image Available";
      }

    const modalProblemImage = document.getElementById('modalProblemImage');
      if (complain_image && complain_image !== "None") {
        modalProblemImage.src = complain_image;
        modalProblemImage.style.display = "block"; 
      } else {
        modalProblemImage.style.display = "none"; 
        document.getElementById('modalProblemPlaceholder').textContent = "No Image Available";
      }

    // document.getElementById('modalSubmittedAt').textContent = submitted_at;
    document.getElementById('modalResolvedAt').textContent = resolved_at;
    document.getElementById('modalFeedbackStatus').textContent = feedback_status;
  }
</script>

{% endblock %} 

